name: <Native> Compile Local Windows

on:
  pull_request:
    paths:
    - 'native/**'

jobs:
  compile_windows:
    name: "Windows"  
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v2
      - name: Download external libraries
        shell: bash
        run: |
          EXT_VERSION=`grep version  native/external-config.json  |awk -F'"' '{print $4}'`
          git clone --branch $EXT_VERSION --depth 1 https://github.com/cocos-creator/engine-native-external native/external

      - name: Generate bindings
        shell: bash
        run: |
          python2 -V
          cd ./native/tools/tojs
          echo "Create auto-generated jsbinding glue codes."
          python2 ./genbindings.py
          rm userconf.ini

      - name: Compile win64
        shell: bash
        env:
          COCOS_ENGINE_DEV: 1
        run: |
          cd $GITHUB_WORKSPACE/templates/windows
          mkdir -p build-win64/proj
          touch build-win64/proj/cfg.cmake
          echo "set(CC_USE_GLES3 ON)" >> build-win64/proj/cfg.cmake
          echo "set(CC_USE_VULKAN ON)" >> build-win64/proj/cfg.cmake
          echo "set(CC_USE_GLES2 ON)" >> build-win64/proj/cfg.cmake
          echo "set(USE_WEBSOCKET_SERVER ON)" >> build-win64/proj/cfg.cmake
          echo "set(CMAKE_CXX_STANDARD_REQUIRED ON)" >> build-win64/proj/cfg.cmake
          mkdir build-win64/assets
          cd build-win64
          RES_DIR=${GITHUB_WORKSPACE//\\//}/templates/windows/build-win64
          COCOS_X_PATH=${GITHUB_WORKSPACE//\\//}/native
          cmake ../ -G"Visual Studio 15 2017" -DRES_DIR=$RES_DIR -DCOCOS_X_PATH=$COCOS_X_PATH -Ax64
          cmake --build . --config Release
          echo "Compile Win64 Release Done!"
